<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Meus Orçamentos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- HEADER -->
  <header class="bg-gradient-to-r from-emerald-500 to-teal-600 shadow-lg px-4 sm:px-6 py-3 flex items-center justify-between text-white sticky top-0 z-50">
    <div class="flex items-center gap-3 min-w-0">
      <div class="w-10 h-10 rounded-full bg-white/20 ring-2 ring-white/50 flex items-center justify-center text-white font-bold text-xl shadow-md flex-shrink-0">
        {{ user.username[0]|upper }}
      </div>
      <span class="font-semibold text-base sm:text-lg truncate">
        Olá, <span class="font-bold">{{ user.username }}</span>
      </span>
    </div>
    <h1 class="hidden sm:block text-white font-bold text-xl sm:text-2xl text-center flex-1 mx-4">
        Meus Orçamentos
    </h1>
    <div class="flex items-center gap-2">
        <a href="/" class="flex items-center gap-2 px-4 py-2 bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-lg shadow-sm transition-all duration-200 border border-white/20 font-semibold text-sm sm:text-base whitespace-nowrap">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
            <span class="hidden sm:inline">Novo Orçamento</span>
        </a>
        <button onclick="abrirModalConfig()" title="Configurações" class="flex items-center justify-center h-10 w-10 bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-lg shadow-sm transition-all duration-200 border border-white/20">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
        </button>
    </div>
  </header>

  <!-- CONTAINER PRINCIPAL -->
  <main class="max-w-4xl mx-auto mt-8 px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between mb-4 mt-2">
      <h2 class="text-xl font-semibold text-gray-800">Últimos Orçamentos</h2>
      <button onclick="carregarOrcamentos()" class="flex items-center gap-2 bg-emerald-600 text-white rounded-lg px-4 py-2 hover:bg-emerald-700 transition-all text-sm font-semibold shadow-md">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
        Atualizar
      </button>
    </div>
    <div id="lista" class="space-y-3"></div>
  </main>

  <!-- MODAL DE CONFIGURAÇÕES -->
  <div id="modal-config" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 transition-opacity duration-300">
      <div id="modal-box" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md transform transition-all -translate-y-10 opacity-0 duration-300 flex flex-col max-h-[95vh] sm:max-h-[90vh]">
          <div class="flex items-center justify-between pb-3 border-b">
              <h3 class="text-xl font-semibold text-gray-800">Configurações</h3>
              <button onclick="fecharModalConfig()" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">×</button>
          </div>
          <div class="mt-4 space-y-6 overflow-y-auto pr-2">
              <div class="bg-gray-50 p-4 rounded-lg border">
                  <div class="flex flex-col sm:flex-row items-center gap-4">
                      <div class="flex-grow">
                          <label for="novo_numero_inicial" class="block text-sm font-medium text-gray-700">Reiniciar contagem a partir de:</label>
                          <p class="text-xs text-gray-500 mt-1">Digite '0' para o próximo orçamento ser o Nº 0001.</p>
                      </div>
                      <div class="flex items-center gap-2">
                          <input type="number" id="novo_numero_inicial" value="0" class="w-24 h-10 text-center font-semibold border border-zinc-300 rounded-md shadow-sm focus:outline-zinc-400">
                          <button onclick="resetarContador()" class="h-10 px-4 bg-orange-500 text-white font-semibold rounded-lg shadow hover:bg-orange-600 transition">Resetar</button>
                      </div>
                  </div>
              </div>

              {% if user.username == admin_username_from_env %}

                <div class="bg-gray-50 p-4 rounded-lg border">
                  <h4 class="text-md font-semibold text-gray-800 mb-2">Mudar Meu Modelo de PDF (Admin)</h4>
                  <div class="flex items-center gap-2">
                      <select id="admin-template-select" class="flex-grow mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                          <option value="joao">Modelo João</option>
                          <option value="cacador">Modelo Caçador</option>
                      </select>
                      <button onclick="atualizarModeloPDF()" class="h-10 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow hover:bg-blue-700 transition">
                          Aplicar
                      </button>
                  </div>
              </div>
              <div class="bg-gray-50 p-4 rounded-lg border">
                  <h4 class="text-md font-semibold text-gray-800 mb-2">Cadastrar Novo Usuário</h4>
                  <div class="space-y-3">
                      <div>
                          <label for="new-username" class="text-sm font-medium text-gray-600">Nome de Usuário:</label>
                          <input type="text" id="new-username" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                      </div>
                      <div>
                          <label for="new-password" class="text-sm font-medium text-gray-600">Senha:</label>
                          <input type="password" id="new-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                      </div>
                      <div>
                          <label for="new-template" class="text-sm font-medium text-gray-600">Modelo de PDF:</label>
                          <select id="new-template" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                              <option value="joao">Modelo João</option>
                              <option value="cacador">Modelo Caçador</option>
                          </select>
                      </div>
                      <button onclick="cadastrarNovoUsuario()" class="w-full h-10 px-4 bg-emerald-600 text-white font-semibold rounded-lg shadow hover:bg-emerald-700 transition">
                          Cadastrar Usuário
                      </button>
                  </div>
              </div>

              <!-- Div de Gerenciar Usuários começa aqui, no nível correto -->
              <div class="bg-gray-50 p-4 rounded-lg border">
                  <h4 class="text-md font-semibold text-gray-800 mb-2">Gerenciar Usuários</h4>
                  <div id="lista-usuarios" class="mt-2 space-y-2 max-h-48 overflow-y-auto">
                      <!-- O JavaScript vai preencher esta lista -->
                      <p class="text-gray-500 text-sm">Carregando usuários...</p>
                  </div>
              </div>
              {% endif %}
          </div>
      </div>
  </div>

    <div id="modal-email" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300">
      <div id="modal-email-box" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md transform transition-all -translate-y-10 opacity-0 duration-300">
          <div class="flex items-center justify-between pb-3 border-b">
              <h3 class="text-xl font-semibold text-gray-800">Enviar Orçamento por E-mail</h3>
              <button onclick="fecharModalEmail()" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">×</button>
          </div>
          <div class="mt-4 space-y-4">
              <p class="text-sm">Enviando orçamento para: <strong id="email-cliente-nome"></strong></p>
              <div>
                  <label for="email-destinatario" class="block text-sm font-medium text-gray-700">E-mail do Destinatário:</label>
                  <input type="email" id="email-destinatario" placeholder="exemplo@email.com" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
              </div>
              <!-- Input oculto para guardar o ID do orçamento -->
              <input type="hidden" id="email-orcamento-id">
              <input type="hidden" id="email-tipo-documento">
              <button id="btn-enviar-email" class="w-full h-10 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow hover:bg-blue-700 transition flex items-center justify-center">
                  
              </button>
          </div>
      </div>
  </div>
    <div id="modal-status-pdf" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300">
      <div id="modal-status-pdf-box" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md transform transition-all -translate-y-10 opacity-0 duration-300">
          <div class="text-center">
              <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                  <svg class="h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
              </div>
              <h3 class="mt-4 text-lg leading-6 font-medium text-gray-900">Tipo de Documento</h3>
              <div class="mt-2 px-7 py-3">
                  <p class="text-sm text-gray-500">
                      O serviço deste documento já foi realizado? Escolha o tipo de documento que deseja gerar.
                  </p>
              </div>
          </div>
          <div class="mt-5 sm:mt-6 grid grid-cols-1 sm:grid-cols-2 gap-3">
              <button id="btn-gerar-orcamento" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700">
                  Gerar Orçamento
              </button>
              <button id="btn-gerar-nota" type="button" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50">
                  Gerar Nota de Serviço
              </button>
          </div>
          <input type="hidden" id="pdf-orcamento-id">
      </div>
  </div>
    <div id="modal-whatsapp" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300">
    <div id="modal-whatsapp-box" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md transform transition-all -translate-y-10 opacity-0 duration-300">
        <div class="flex items-center justify-between pb-3 border-b">
            <h3 class="text-xl font-semibold text-gray-800">Enviar por WhatsApp</h3>
            <button onclick="fecharModalWhatsApp()" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">×</button>
        </div>
        <div class="mt-4 space-y-4">
            <p class="text-sm">Selecione os contatos para enviar o orçamento:</p>
            <div id="lista-contatos-whatsapp" class="space-y-2 border-t border-b py-3 max-h-48 overflow-y-auto">
                <!-- A lista de contatos com checkboxes vai aqui -->
            </div>
            <input type="hidden" id="whatsapp-orcamento-id">
            <button id="btn-enviar-whatsapp-final" class="w-full h-10 px-4 bg-green-600 text-white font-semibold rounded-lg shadow hover:bg-green-700 transition flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.789 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                Enviar para Selecionados
            </button>
        </div>
    </div>
  </div>
    <div id="modal-tipo-documento" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[60]">
      <div id="modal-tipo-documento-box" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm mx-4 transform transition-all -translate-y-10 opacity-0 duration-300">
          <!-- Título -->
          <h3 class="text-lg font-medium text-gray-900 text-center">Qual documento deseja enviar?</h3>
          
          <!-- Conteúdo/Opções -->
          <div class="mt-4 space-y-3">
              <p class="text-sm text-center text-gray-500">
                  Selecione o tipo de documento que será gerado para o compartilhamento via WhatsApp.
              </p>
              <div class="pt-2">
                  <label class="flex items-center p-3 w-full bg-white border rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                      <input type="radio" name="tipo_documento_escolha" value="Orçamento" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked>
                      <span class="ml-3 text-sm font-medium text-gray-800">Enviar como Orçamento</span>
                  </label>
              </div>
              <div>
                  <label class="flex items-center p-3 w-full bg-white border rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                      <input type="radio" name="tipo_documento_escolha" value="Nota de Serviço" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                      <span class="ml-3 text-sm font-medium text-gray-800">Enviar como Nota de Serviço</span>
                  </label>
              </div>
          </div>

          <!-- Botões de Ação -->
          <div class="mt-6 flex justify-end gap-3">
              <button type="button" class="btn-fechar-modal-tipo-documento px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
              <button type="button" id="btn-confirmar-tipo-documento" class="px-4 py-2 bg-emerald-600 text-white font-semibold rounded-md hover:bg-emerald-700">Confirmar</button>
          </div>

          <!-- ID do orçamento será guardado aqui -->
          <input type="hidden" id="tipo-documento-orcamento-id">
      </div>
    </div>

  <script>

    const modalEmail = document.getElementById('modal-email');
    const modalEmailBox = document.getElementById('modal-email-box');
    const emailClienteNome = document.getElementById('email-cliente-nome');
    const emailInput = document.getElementById('email-destinatario');
    const emailOrcamentoIdInput = document.getElementById('email-orcamento-id');
    const btnEnviarEmail = document.getElementById('btn-enviar-email');
    const modalBox = document.getElementById('modal-box');
    const modal = document.getElementById('modal-config');
    const modalStatusPdf = document.getElementById('modal-status-pdf');
    const modalStatusPdfBox = document.getElementById('modal-status-pdf-box');
    const pdfOrcamentoIdInput = document.getElementById('pdf-orcamento-id');
    const modalWhatsApp = document.getElementById('modal-whatsapp');
    const modalWhatsAppBox = document.getElementById('modal-whatsapp-box');
    const whatsappOrcamentoIdInput = document.getElementById('whatsapp-orcamento-id');
    const btnEnviarWhatsAppFinal = document.getElementById('btn-enviar-whatsapp-final');
    const modalTipoDocumento = document.getElementById('modal-tipo-documento');
    const modalTipoDocumentoBox = document.getElementById('modal-tipo-documento-box');
    const tipoDocumentoOrcamentoIdInput = document.getElementById('tipo-documento-orcamento-id');
    const btnConfirmarTipoDocumento = document.getElementById('btn-confirmar-tipo-documento');
    const btnsFecharModalTipoDocumento = document.querySelectorAll('.btn-fechar-modal-tipo-documento');


    function abrirModalEmail(orcamentoId, clienteNome, clienteEmail, tipoDocumento) {
      emailClienteNome.textContent = clienteNome;
      emailOrcamentoIdInput.value = orcamentoId;
      emailInput.value = clienteEmail;
      
      // Guarda o tipo de documento que foi escolhido no passo anterior
      document.getElementById('email-tipo-documento').value = tipoDocumento;

      modalEmail.classList.remove('hidden');
      modalEmail.classList.add('flex');
      setTimeout(() => { modalEmailBox.classList.remove('-translate-y-10', 'opacity-0'); emailInput.focus(); }, 50);
    }

    function fecharModalEmail() {
      modalEmailBox.classList.add('-translate-y-10', 'opacity-0');
      setTimeout(() => { 
          modalEmail.classList.add('hidden'); 
          modalEmail.classList.remove('flex'); 
          btnEnviarEmail.disabled = false;
          btnEnviarEmail.innerHTML = 'Abrir App de E-mail';
      }, 300);
    }

    modalEmail.addEventListener('click', (event) => { if (event.target === modalEmail) fecharModalEmail(); });


    btnConfirmarTipoDocumento.addEventListener('click', async () => {
      const orcamentoId = tipoDocumentoOrcamentoIdInput.value;
      const tipoDocumento = document.querySelector('input[name="tipo_documento_escolha"]:checked').value;
      const acao = modalTipoDocumento.dataset.acao;
      
      fecharModalTipoDocumento();

      try {
          // ETAPA ESSENCIAL: gera o PDF/token silenciosamente com o tipo correto.
          await fetch(`/orcamento/${orcamentoId}/pdf?status=${encodeURIComponent(tipoDocumento)}`);
          
          if (acao === 'whatsapp') {
              const orcamentoRes = await fetch('/api/orcamentos/');
              if (!orcamentoRes.ok) throw new Error("Falha ao buscar dados do orçamento.");
              const orcamentos = await orcamentoRes.json();
              const orcamentoAtual = orcamentos.find(o => o.id === parseInt(orcamentoId));
              
              // AGORA sim abrimos o modal de seleção de contatos.
              abrirModalWhatsApp(orcamentoId, orcamentoAtual?.telefone || '');

          } else if (acao === 'email') {
              const orcamentoRes = await fetch('/api/orcamentos/');
              if (!orcamentoRes.ok) throw new Error("Falha ao buscar dados.");
              const orcamentos = await orcamentoRes.json();
              const orcamentoAtual = orcamentos.find(o => o.id === parseInt(orcamentoId));
              abrirModalEmail(orcamentoId, orcamentoAtual?.nome || '', '', tipoDocumento);
          }
      } catch(e) {
          alert(e.message);
      }
    });


    async function abrirClienteDeEmail() {
      const orcamentoId = emailOrcamentoIdInput.value;
      const destinatario = emailInput.value.trim();
      // Pega o tipo de documento que guardamos no input oculto
      const tipoDocumento = document.getElementById('email-tipo-documento').value;

      if (!destinatario) {
          alert("Por favor, insira o e-mail do destinatário.");
          return;
      }

      btnEnviarEmail.disabled = true;
      btnEnviarEmail.innerHTML = 'Gerando link...';

      try {
          // Primeiro, gera o PDF silenciosamente com o TIPO CORRETO para criar o link público
        await fetch(`/orcamento/${orcamentoId}/pdf?status=${encodeURIComponent(tipoDocumento)}`);

        // Agora, gera o link mailto, que já buscará o token recém-criado
        const formData = new FormData();
        formData.append('destinatario', destinatario);
        
        const response = await fetch(`/orcamento/${orcamentoId}/email/link?status=${encodeURIComponent(tipoDocumento)}`, {
            method: 'POST',
            body: formData
        });

        if (!response.ok) throw new Error((await response.json()).detail);
        const data = await response.json();
        
        // Abre o cliente de e-mail do usuário
        window.location.href = data.mailto_link;
        fecharModalEmail();

      } catch (error) {
          alert(`Ocorreu um erro: ${error.message}`);
          fecharModalEmail(); // Fecha o modal mesmo se der erro
      }
    }
    // Define o clique e o texto do botão do modal
    document.getElementById('btn-enviar-email').onclick = abrirClienteDeEmail;
    document.getElementById('btn-enviar-email').textContent = "Abrir App de E-mail";


    // --- FUNÇÕES DE CONTROLE DO MODAL DE CONFIGURAÇÕES (sem alteração) ---
    function abrirModalConfig() {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      setTimeout(() => { modalBox.classList.remove('-translate-y-10', 'opacity-0'); }, 50);
      
      if ("{{ user.username }}" === "{{ admin_username_from_env }}") {
          carregarListaUsuarios();
      }
    }
    function fecharModalConfig() {
      modalBox.classList.add('-translate-y-10', 'opacity-0');
      setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 300);
    }
    modal.addEventListener('click', (event) => { if (event.target === modal) fecharModalConfig(); });

    async function carregarListaUsuarios() {
      const container = document.getElementById('lista-usuarios');
      container.innerHTML = `<p class="text-gray-500 text-sm">Carregando...</p>`;

      try {
        const response = await fetch('/api/users/');
        if (!response.ok) {
            // Se a resposta não for OK, pode ser um erro de permissão (403) ou outro
            const errorData = await response.json();
            throw new Error(errorData.detail || "Falha ao carregar usuários.");
        }
        const users = await response.json();
        
        container.innerHTML = ''; // Limpa o container

        if (users.length <= 1) { // Só o admin existe
            container.innerHTML = `<p class="text-gray-400 text-sm">Nenhum outro usuário cadastrado.</p>`;
            return;
        }
          
        users.forEach(user => {
          // Não mostra o próprio admin na lista de "apagáveis"
          if (user.username === "{{ user.username }}") return;

          const userDiv = document.createElement('div');
          userDiv.className = 'flex items-center justify-between p-2 bg-white rounded-md border';
          userDiv.id = `user-row-${user.id}`;
          
          userDiv.innerHTML = `
              <span class="text-gray-700 font-medium">${user.username}</span>
              <button onclick="deletarUsuario(${user.id}, '${user.username}')" class="px-2 py-1 text-xs font-semibold text-red-700 bg-red-100 rounded-md hover:bg-red-200">
                  Apagar
              </button>
          `;
          container.appendChild(userDiv);
        });

      } catch (error) {
        console.error("Erro ao carregar usuários:", error);
        container.innerHTML = `<p class="text-red-500 text-sm">${error.message}</p>`;
      }
    }

    async function deletarUsuario(userId, username) {
        if (!confirm(`Tem certeza que deseja apagar permanentemente o usuário "${username}"?\nTODOS os orçamentos e clientes deste usuário serão perdidos.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/users/${userId}`, {
                method: 'DELETE'
            });

            if (response.status === 204) {
                alert(`Usuário "${username}" apagado com sucesso!`);
                const userRow = document.getElementById(`user-row-${userId}`);
                if (userRow) {
                    userRow.remove();
                }
            } else {
                const errorData = await response.json();
                throw new Error(errorData.detail || "Falha ao apagar o usuário.");
            }
        } catch (error) {
            console.error("Erro ao apagar usuário:", error);
            alert(`Ocorreu um erro: ${error.message}`);
        }
      }

    // --- FUNÇÕES DE LÓGICA DA PÁGINA ---
    async function carregarOrcamentos() {
      const lista = document.getElementById('lista');
      lista.innerHTML = `<div class="py-8 text-center text-gray-400">Carregando...</div>`;
      try {
        const res = await fetch('/api/orcamentos/');
        if (!res.ok) throw new Error('Falha ao carregar os dados.');
        const orcamentos = await res.json();
        lista.innerHTML = "";
        if (!orcamentos.length) {
          lista.innerHTML = `<div class="py-8 text-center text-gray-400">Nenhum orçamento encontrado.</div>`;
          return;
        }
        orcamentos.forEach(orc => {
          const totalFormatado = parseFloat(orc.total_geral).toLocaleString('pt-BR', {minimumFractionDigits: 2});
          lista.innerHTML += `
            <div id="orcamento-card-${orc.id}" class="bg-white shadow-md rounded-lg px-5 py-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 border border-gray-200">
              <div class="flex items-center gap-4 flex-grow min-w-0">
                <span class="font-bold text-emerald-600">#${String(orc.numero).padStart(4, '0')}</span>
                <span class="text-gray-800 truncate" title="${orc.nome}">${orc.nome}</span>
                <span class="text-xs text-gray-400 whitespace-nowrap">(${orc.data_emissao})</span>
              </div>
              <div class="flex items-center justify-between flex-grow sm:flex-grow-0 sm:w-80">
                  <span class="text-emerald-600 font-bold text-lg">R$ ${totalFormatado}</span>
                  <div class="flex items-center gap-2">
                      <button onclick="editarOrcamento(${orc.id})" title="Editar Orçamento" class="p-2 rounded bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                      <button onclick="abrirModalStatusPDF(${orc.id})" title="Ver PDF" class="p-2 rounded bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" /></svg></button>
                      <button onclick="abrirModalTipoDocumento(${orc.id}, 'email')" title="Enviar por E-mail" class="p-2 rounded bg-blue-500 text-white hover:bg-blue-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M3 4a2 2 0 00-2 2v1.161l8.441 4.221a1.25 1.25 0 001.118 0L19 7.162V6a2 2 0 00-2-2H3z" />
                          <path d="M19 8.839l-7.77 3.885a2.75 2.75 0 01-2.46 0L1 8.839V14a2 2 0 002 2h14a2 2 0 002-2V8.839z" />
                        </svg>
                      </button>
                      <button onclick="abrirModalTipoDocumento(${orc.id}, 'whatsapp')" title="Enviar por WhatsApp" class="p-2 rounded bg-green-500 text-white hover:bg-green-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.789 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg></button>
                      <button onclick="deletarOrcamento(${orc.id})" title="Excluir Orçamento" class="p-2 rounded bg-red-500 text-white hover:bg-red-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                  </div>
              </div>
            </div>
          `;
        });
      } catch (e) {
        console.error("Erro ao carregar orçamentos:", e);
        lista.innerHTML = `<div class="py-8 text-center text-red-400">Erro ao carregar orçamentos.</div>`;
      }
    }

    function abrirModalTipoDocumento(orcamentoId, acao) {
        // Guarda o ID e a AÇÃO (agora pode ser 'whatsapp' ou 'email')
        tipoDocumentoOrcamentoIdInput.value = orcamentoId; 
        
        // Adiciona a ação a um atributo de dados para usarmos depois
        modalTipoDocumento.dataset.acao = acao; 

        // Define o texto do botão de confirmação dinamicamente
        if (acao === 'whatsapp') {
            btnConfirmarTipoDocumento.textContent = 'Confirmar';
        } else if (acao === 'email') {
            btnConfirmarTipoDocumento.textContent = 'Confirmar';
        }
        
        document.querySelector('input[name="tipo_documento_escolha"][value="Orçamento"]').checked = true;
        modalTipoDocumento.classList.remove('hidden');
        modalTipoDocumento.classList.add('flex');
        setTimeout(() => { modalTipoDocumentoBox.classList.remove('-translate-y-10', 'opacity-0'); }, 50);
    }

    function fecharModalTipoDocumento() {
        modalTipoDocumentoBox.classList.add('-translate-y-10', 'opacity-0');
        setTimeout(() => { modalTipoDocumento.classList.add('hidden'); modalTipoDocumento.classList.remove('flex'); }, 300);
    }

    function editarOrcamento(id) { window.location.href = `/editar-orcamento/${id}`; }

    function abrirModalStatusPDF(orcamentoId) {
      pdfOrcamentoIdInput.value = orcamentoId; // Guarda o ID do orçamento
      modalStatusPdf.classList.remove('hidden');
      modalStatusPdf.classList.add('flex');
      setTimeout(() => { modalStatusPdfBox.classList.remove('-translate-y-10', 'opacity-0'); }, 50);
    }

    function fecharModalStatusPDF() {
      modalStatusPdfBox.classList.add('-translate-y-10', 'opacity-0');
      setTimeout(() => { modalStatusPdf.classList.add('hidden'); modalStatusPdf.classList.remove('flex'); }, 300);
    }

    document.getElementById('btn-gerar-orcamento').addEventListener('click', () => {
      const id = pdfOrcamentoIdInput.value;
      // Abre o PDF com o status padrão 'Orçamento'
      window.open(`/orcamento/${id}/pdf?status=Orçamento`, "_blank");
      fecharModalStatusPDF();
    });

    document.getElementById('btn-gerar-nota').addEventListener('click', () => {
      const id = pdfOrcamentoIdInput.value;
      // Abre o PDF com o status 'Nota de Serviço'
      window.open(`/orcamento/${id}/pdf?status=Nota de Serviço`, "_blank");
      fecharModalStatusPDF();
    });

    // Listener para fechar o modal clicando fora
    modalStatusPdf.addEventListener('click', (event) => {
      if(event.target === modalStatusPdf) {
          fecharModalStatusPDF();
      }
    });

    function baixarPDF(id) { window.open(`/orcamento/${id}/pdf`, "_blank"); }

    function isMobile() {
      return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);
    }

  function abrirModalWhatsApp(orcamentoId, telefonePrincipal, tipoDeDocumento) { // Alteramos o terceiro parâmetro
    whatsappOrcamentoIdInput.value = orcamentoId;

    // Apenas guarda o TIPO de documento escolhido para usar depois.
    let hiddenTipo = document.getElementById('whatsapp-tipo-documento');
    if (!hiddenTipo) {
        hiddenTipo = document.createElement('input');
        hiddenTipo.type = 'hidden';
        hiddenTipo.id = 'whatsapp-tipo-documento';
        modalWhatsAppBox.appendChild(hiddenTipo);
    }
    hiddenTipo.value = tipoDeDocumento; 

    // O resto da função é SÓ para mostrar o modal e os contatos
    const listaContatosDiv = document.getElementById('lista-contatos-whatsapp');
    listaContatosDiv.innerHTML = `<p class="text-gray-500 text-sm p-2">Carregando...</p>`;
    modalWhatsApp.classList.remove('hidden');
    modalWhatsApp.classList.add('flex');
    setTimeout(() => { modalWhatsAppBox.classList.remove('-translate-y-10', 'opacity-0'); }, 50);

    fetch(`/api/orcamento/${orcamentoId}/contatos`)
      .then(res => res.json())
      .then(contatosExtras => {
        listaContatosDiv.innerHTML = '';
        let listaCompleta = [...contatosExtras];
        if (telefonePrincipal && telefonePrincipal.trim() !== '') {
            listaCompleta.unshift({ nome: "Contato Principal", telefone: telefonePrincipal });
        }
        if (listaCompleta.length === 0) {
            listaContatosDiv.innerHTML = `<p class="text-red-500 text-sm p-2">Nenhum telefone encontrado.</p>`;
            return;
        }
        listaCompleta.forEach(contato => {
            const label = document.createElement('label');
            label.className = "flex items-center gap-3 p-2 rounded-md hover:bg-gray-100 cursor-pointer";
            label.innerHTML = `
                <input type="checkbox" value="${contato.telefone}" class="h-4 w-4 rounded border-gray-300">
                <span class="text-gray-700">${contato.nome} (${contato.telefone})</span>`;
            listaContatosDiv.appendChild(label);
        });
    });
  }
    

  function fecharModalWhatsApp() {
    modalWhatsAppBox.classList.add('-translate-y-10', 'opacity-0');
    setTimeout(() => { modalWhatsApp.classList.add('hidden'); modalWhatsApp.classList.remove('flex'); }, 300);
  }


  async function deletarOrcamento(id) {
    if (!confirm(`Tem certeza que deseja excluir o orçamento?`)) return;
    try {
      const response = await fetch(`/api/orcamentos/${id}`, { method: 'DELETE' });
      if (response.status === 204) {
        const card = document.getElementById(`orcamento-card-${id}`);
        if (card) {
          card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
          card.style.opacity = '0';
          card.style.transform = 'scale(0.95)';
          setTimeout(() => card.remove(), 500);
        }
      } else {
        const errorData = await response.json();
        throw new Error(errorData.detail || "Falha ao excluir o orçamento.");
      }
    } catch (error) {
      console.error("Erro ao deletar orçamento:", error);
      alert("Ocorreu um erro: " + error.message);
    }
  }

  async function resetarContador() {
      const inputNumero = document.getElementById('novo_numero_inicial');
      const novoValor = inputNumero.value;
      if (novoValor === "" || isNaN(parseInt(novoValor)) || parseInt(novoValor) < 0) {
          alert("Por favor, insira um número válido (0 ou maior)."); return;
      }
      if (!confirm(`Tem certeza? O próximo orçamento será o Nº ${parseInt(novoValor) + 1}.`)) return;
      try {
          const formData = new FormData();
          formData.append('novo_inicio', novoValor);
          const response = await fetch('/api/resetar-contador/', { method: 'POST', body: formData });
          const result = await response.json();
          if (!response.ok) throw new Error(result.detail || "Erro desconhecido.");
          alert(result.message);
          fecharModalConfig();
      } catch (error) {
          console.error("Erro ao resetar contador:", error);
          alert(`Ocorreu um erro: ${error.message}`);
      }
  }

  async function atualizarModeloPDF() {
    const select = document.getElementById('admin-template-select');
    const novoModelo = select.value;

    if (!confirm(`Tem certeza que deseja mudar seu modelo de PDF para '${novoModelo.charAt(0).toUpperCase() + novoModelo.slice(1)}'?`)) {
        return;
    }

    const formData = new FormData();
    formData.append('new_template', novoModelo);

    try {
        const response = await fetch('/api/user/update-template', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.detail || "Ocorreu um erro desconhecido.");
        }

        alert(result.message);
        fecharModalConfig(); // Fecha o modal após o sucesso

    } catch (error) {
        console.error("Erro ao atualizar modelo de PDF:", error);
        alert(`Ocorreu um erro: ${error.message}`);
    }
  }


  async function cadastrarNovoUsuario() {
    const usernameInput = document.getElementById('new-username');
    const passwordInput = document.getElementById('new-password');
    const templateInput = document.getElementById('new-template'); // Pega o elemento <select>

    // 1. Pega TODOS os valores dos campos PRIMEIRO
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();
    const template = templateInput.value; // Pega o valor selecionado (ex: "joao" ou "cacador")

    if (!username || !password) {
        alert("Por favor, preencha o nome de usuário e a senha.");
        return;
    }

    // 2. Cria o objeto FormData UMA ÚNICA VEZ
    const formData = new FormData();

    // 3. Adiciona TODOS os dados ao mesmo objeto FormData
    formData.append('username', username);
    formData.append('password', password);
    formData.append('pdf_template_name', template); // Adiciona o modelo de PDF

    try {
        const response = await fetch('/api/users/', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.detail || "Erro desconhecido ao cadastrar usuário.");
        }

        alert(result.message);
        usernameInput.value = '';
        passwordInput.value = '';

    } catch (error) {
        console.error("Erro ao cadastrar usuário:", error);
        alert(`Ocorreu um erro: ${error.message}`);
    }
  }

  function inicializar() {
    // Listeners dos Modais
    document.getElementById('btn-enviar-email').onclick = abrirClienteDeEmail;
    modalEmail.addEventListener('click', (e) => { if (e.target === modalEmail) fecharModalEmail(); });
    modal.addEventListener('click', (e) => { if (e.target === modal) fecharModalConfig(); });
    
    // Listeners do modal antigo de status PDF/Email
    document.getElementById('btn-gerar-orcamento').addEventListener('click', () => { window.open(`/orcamento/${pdfOrcamentoIdInput.value}/pdf?status=Orçamento`, "_blank"); fecharModalStatusPDF(); });
    document.getElementById('btn-gerar-nota').addEventListener('click', () => { window.open(`/orcamento/${pdfOrcamentoIdInput.value}/pdf?status=Nota de Serviço`, "_blank"); fecharModalStatusPDF(); });
    modalStatusPdf.addEventListener('click', (e) => { if (e.target === modalStatusPdf) fecharModalStatusPDF(); });

    // Listeners do modal de SELEÇÃO DE CONTATO WhatsApp
    btnEnviarWhatsAppFinal.addEventListener('click', async () => {
      const orcamentoId = whatsappOrcamentoIdInput.value;
      const checkboxes = document.querySelectorAll('#lista-contatos-whatsapp input[type="checkbox"]:checked');

      if (checkboxes.length === 0) {
          alert("Por favor, selecione pelo menos um contato para enviar.");
          return;
      }

      try {
          const response = await fetch(`/orcamento/${orcamentoId}/whatsapp`);
          if (!response.ok) throw new Error("Não foi possível gerar a mensagem.");
          const data = await response.json();
          const mensagemBase = data.whatsapp_message;

          checkboxes.forEach((check, index) => {
            const telefoneLimpo = check.value.replace(/\D/g, '');
            if (!telefoneLimpo) return;
            const telefoneFinal = telefoneLimpo.startsWith("55") ? telefoneLimpo : "55" + telefoneLimpo;
            const urlFinal = `https://wa.me/${telefoneFinal}?text=${mensagemBase}`;
            // Simples assim: isso funciona perfeito em PC e mobile!
            setTimeout(() => { 
              if (isMobile()) {
                // Tenta abrir o app via window.open
                let win = window.open(`whatsapp://send?phone=${telefoneFinal}&text=${encodeURIComponent(mensagemBase)}`);
                // Fallback via wa.me se não funcionar em 700ms
                setTimeout(() => {
                  if (!win || win.closed || typeof win.closed === 'undefined') {
                    window.open(urlFinal, '_blank');
                  }
                }, 700);
              } else {
                window.open(urlFinal, '_blank');
              }
            }, index * 300);
          });

          fecharModalWhatsApp();
      } catch (error) {
          alert("Ocorreu um erro: " + error.message);
      }
    });

    modalWhatsApp.addEventListener('click', (e) => { if (e.target === modalWhatsApp) fecharModalWhatsApp(); });

    // **NOVO**: Listeners para o novo modal de ESCOLHA do WhatsApp
    btnsFecharModalTipoDocumento.forEach(btn => btn.addEventListener('click', fecharModalTipoDocumento));
    modalTipoDocumento.addEventListener('click', (e) => { if (e.target === modalTipoDocumento) fecharModalTipoDocumento(); });

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('atualizado')) {
        const notificacao = document.createElement('div');
        notificacao.className = 'fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg';
        notificacao.innerText = 'Orçamento atualizado com sucesso!';
        document.body.appendChild(notificacao);
        setTimeout(() => { notificacao.remove(); window.history.replaceState({}, document.title, "/orcamentos"); }, 3000);
    }
     carregarOrcamentos();
  }
    // Carrega os orçamentos assim que o script é lido
    inicializar();
  </script>
</body>
</html> 