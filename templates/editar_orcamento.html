<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Orçamento #{{ orcamento.numero }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <!-- Bloco para injetar dados do Jinja2 para o JavaScript de forma segura -->
    <script>
        const orcamentoData = JSON.parse('{{ orcamento.json() | safe }}');
    </script>
    
    <!-- HEADER -->
    <header class="bg-gradient-to-r from-emerald-500 to-teal-600 shadow-lg px-4 sm:px-6 py-3 flex items-center justify-between text-white sticky top-0 z-50">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-white/20 ring-2 ring-white/50 flex items-center justify-center text-white font-bold text-xl shadow-md flex-shrink-0">
          {{ user.username[0]|upper }}
        </div>
        <div class="font-semibold text-base sm:text-lg">
          Olá, <span class="font-bold">{{ user.username }}</span>
        </div>
      </div>
      <div class="flex items-center gap-2 sm:gap-3">
        <a href="/orcamentos" class="flex items-center gap-2 px-3 py-2 bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-lg shadow-sm transition-all duration-200 border border-white/20">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h4a1 1 0 100-2H7zm0 4a1 1 0 100 2h4a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
          <span class="font-semibold hidden sm:inline">Orçamentos</span>
        </a>
        <a href="/logout" class="flex items-center gap-2 px-3 py-2 bg-red-500/80 hover:bg-red-500 backdrop-blur-sm rounded-lg shadow-sm transition-all duration-200 border border-white/20">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" /></svg>
          <span class="font-semibold hidden sm:inline">Sair</span>
        </a>
      </div>
    </header>

    <!-- FORMULÁRIO PRINCIPAL -->
    <div class="flex flex-col gap-8 p-8 max-w-4xl mx-auto">
        <h1 class="text-3xl font-extrabold text-center text-gray-800">
            Editar Orçamento #<span id="titulo_numero_orcamento"></span>
        </h1>
        <form id="orcamentoForm" action="/atualizar-orcamento/{{ orcamento.id }}" method="post" class="flex flex-col gap-4">
            
            <!-- SEÇÃO DE DADOS DO CLIENTE -->
            <h2 class="text-xl font-bold text-gray-700 mt-4 border-b pb-2">Dados do Cliente</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="nome" class="text-sm font-bold">Nome do Cliente:</label><input class="h-10 w-full px-3 border border-zinc-300 rounded-lg" type="text" id="nome" name="nome" required></div>
                <div><label for="telefone" class="text-sm font-bold">Telefone:</label><input class="h-10 w-full px-3 border border-zinc-300 rounded-lg" type="tel" id="telefone" name="telefone" required></div>
                <div><label for="cep" class="text-sm font-bold">CEP:</label><input class="h-10 w-full px-3 border border-zinc-300 rounded-lg" type="text" id="cep" name="cep"></div>
                <div><label for="logradouro" class="text-sm font-bold">Rua:</label><input class="h-10 w-full px-3 border border-zinc-300 rounded-lg" type="text" id="logradouro" name="logradouro"></div>
                <div><label for="numero_casa" class="text-sm font-bold">Número:</label><input class="h-10 w-full px-3 border border-zinc-300 rounded-lg" type="text" id="numero_casa" name="numero_casa"></div>
                <div><label for="bairro" class="text-sm font-bold">Bairro:</label><input class="h-10 w-full px-3 border border-zinc-300 rounded-lg" type="text" id="bairro" name="bairro"></div>
                <div><label for="cidade_uf" class="text-sm font-bold">Cidade/UF:</label><input class="h-10 w-full px-3 border border-zinc-300 rounded-lg" type="text" id="cidade_uf" name="cidade_uf"></div>
                <div><label for="complemento" class="text-sm font-bold">Complemento:</label><input class="h-10 w-full px-3 border border-zinc-300 rounded-lg" type="text" id="complemento" name="complemento"></div>
            </div>

            <!-- SEÇÃO DE DETALHAMENTO -->
            <h2 class="text-xl font-bold text-gray-700 mt-6 border-b pb-2">Detalhamento do Orçamento</h2>
            <div>
                <label for="descricaoServico" class="text-sm font-bold">Descrição Principal do Serviço:</label>
                <input class="h-10 w-full px-3 border border-zinc-300 rounded-lg" type="text" id="descricaoServico" name="descricao_servico" required>
                <input type="hidden" id="numero_orcamento" name="numero_orcamento">
            </div>

            <div class="bg-gray-200 p-4 rounded-lg mt-4">
                <h3 class="font-bold text-gray-800 mb-2">Adicionar Novo Item ao Orçamento</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div class="md:col-span-2"><label for="item" class="text-sm font-bold">Item:</label><input class="h-10 w-full px-3 border border-zinc-300 rounded-lg" type="text" id="item"></div>
                    <div><label class="text-sm font-bold" for="itemQtd">Qtd:</label><input class="h-10 w-full px-3 border border-zinc-300 rounded-lg" type="number" id="itemQtd" value="1"></div>
                    <div><label class="text-sm font-bold" for="itemValor">Valor(unit):</label><input class="h-10 w-full px-3 border border-zinc-300 rounded-lg" type="text" id="itemValor"></div>
                    <div class="md:col-span-4"><button id="adicionarItemBtn" class="w-full py-2 bg-emerald-600 text-white font-semibold rounded-lg hover:bg-emerald-700" type="button">Adicionar Item</button></div>
                </div>
            </div>
            
            <div class="relative overflow-x-auto shadow-md sm:rounded-lg mt-4 hidden" id="tableContainer">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th scope="col" class="px-4 py-3">Item</th><th scope="col" class="px-4 py-3 text-center">Qtd</th><th scope="col" class="px-4 py-3 text-right">Valor Unit</th><th scope="col" class="px-4 py-3 text-right">Total</th><th scope="col" class="px-4 py-3 text-center">Ação</th></tr></thead>
                    <tbody id="itensContainer"></tbody>
                </table>
            </div>
            
            <!-- CAMPOS OCULTOS -->
            <input type="hidden" name="itens" id="hiddenItens" />    
            <input type="hidden" name="condicao_pagamento" id="hidden_condicao_pagamento" />
            <input type="hidden" name="prazo_entrega" id="hidden_prazo_entrega" />
            <input type="hidden" name="garantia" id="hidden_garantia" />
            <input type="hidden" name="observacoes" id="hidden_observacoes" />
            
            <!-- BOTÕES DE AÇÃO PRINCIPAIS -->
            <div class="mt-8 flex flex-col gap-3">
                <button type="button" id="btn-abrir-modal-info" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-white border border-gray-300 text-gray-700 font-semibold rounded-lg shadow-sm hover:bg-gray-100 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0ZM9.25 12.25a.75.75 0 0 0 1.5 0v-2.5a.75.75 0 0 0-1.5 0v2.5ZM10 6a.75.75 0 0 0 0 1.5h.008a.75.75 0 0 0 0-1.5H10Z" clip-rule="evenodd" /></svg>
                    Editar Informações Adicionais
                </button>
                 <button type="submit" class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition-all">
                    Atualizar Orçamento
                </button>
            </div>
        </form>
    </div>

    <!-- MODAL DE INFORMAÇÕES ADICIONAIS -->
    <div id="modal-info" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300">
        <div id="modal-info-box" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg mx-4 transform transition-all -translate-y-10 opacity-0 duration-300">
            <div class="flex items-center justify-between pb-3 border-b"><div class="flex items-center gap-3"><div class="flex-shrink-0 bg-gray-100 p-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5 text-gray-600"><path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0ZM9.25 12.25a.75.75 0 0 0 1.5 0v-2.5a.75.75 0 0 0-1.5 0v2.5ZM10 6a.75.75 0 0 0 0 1.5h.008a.75.75 0 0 0 0-1.5H10Z" clip-rule="evenodd" /></svg></div><h3 class="text-xl font-semibold text-gray-800">Informações Complementares</h3></div><button id="btn-fechar-modal-info" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">×</button></div>
            <div class="mt-4 space-y-4">
                <div><label for="info-condicao-pagamento" class="block text-sm font-medium text-gray-700">Condição de Pagamento:</label><select id="info-condicao-pagamento" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"><option value="">-- Nenhuma --</option><option value="À vista">À vista</option><option value="Pix">Pix</option><option value="Cartão de Crédito">Cartão de Crédito</option><option value="50% de entrada, 50% na entrega">50% de entrada, 50% na entrega</option><option value="A combinar">A combinar</option></select></div>
                <div><label for="info-prazo-entrega" class="block text-sm font-medium text-gray-700">Prazo de Entrega/Execução:</label><input type="text" id="info-prazo-entrega" placeholder="Ex: 7 dias úteis" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
                <div><label for="info-garantia" class="block text-sm font-medium text-gray-700">Garantia:</label><input type="text" id="info-garantia" placeholder="Ex: 90 dias para o serviço" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
                <div><label for="info-observacoes" class="block text-sm font-medium text-gray-700">Observações Adicionais:</label><textarea id="info-observacoes" rows="3" placeholder="Detalhes extras..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea></div>
            </div>
            <div class="mt-6 pt-4 border-t text-right">
                <button id="btn-salvar-info" class="inline-flex items-center gap-2 bg-emerald-600 text-white font-semibold py-2 px-6 rounded-lg shadow hover:bg-emerald-700">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.052-.143Z" clip-rule="evenodd" /></svg>
                    Confirmar
                </button>
            </div>
        </div>
    </div>

<script>
document.addEventListener("DOMContentLoaded", function() {

    // --- 1. DADOS INICIAIS ---
    let itens = orcamentoData.itens || [];

    // --- 2. ELEMENTOS DO DOM ---
    const form = document.getElementById("orcamentoForm");
    const tableContainer = document.getElementById("tableContainer");
    const itensContainer = document.getElementById("itensContainer");
    const itemInput = document.getElementById("item");
    const itemQtdInput = document.getElementById("itemQtd");
    const itemValorInput = document.getElementById("itemValor");
    const adicionarItemBtn = document.getElementById("adicionarItemBtn");

    const modalInfo = document.getElementById('modal-info');
    const modalInfoBox = document.getElementById('modal-info-box');
    const btnAbrirModalInfo = document.getElementById('btn-abrir-modal-info');
    const btnFecharModalInfo = document.getElementById('btn-fechar-modal-info');
    const btnSalvarInfo = document.getElementById('btn-salvar-info');

    // --- 3. FUNÇÕES ---

    function formatarMoeda(e) { 
        let v = e.target.value.replace(/\D/g, "");
        e.target.value = !v ? "" : (parseFloat(v) / 100).toLocaleString("pt-BR", { minimumFractionDigits: 2 }); 
    }
    
    function mascara(e, p) { let i = 0, v = e.target.value.replace(/\D/g, ""); e.target.value = p.replace(/#/g, () => v[i++] || ""); }

    function updateTableVisibility() { 
        tableContainer.classList.toggle("hidden", itens.length === 0); 
    }

    function limparCamposItem() {
        itemInput.value = "";
        itemQtdInput.value = "1";
        itemValorInput.value = "";
        itemInput.focus();
    }

    function adicionarItemNaTela(item) {
        const total = (item.quantidade || 0) * (item.valor || 0);
        const tr = document.createElement("tr");
        tr.className = "bg-white border-b hover:bg-gray-50";
        tr.dataset.id = item.id;
        tr.innerHTML = `
            <td class="px-4 py-3 font-medium text-gray-900">${item.nome}</td>
            <td class="px-4 py-3 text-center">${item.quantidade}</td>
            <td class="px-4 py-3 text-right">${(item.valor || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</td>
            <td class="px-4 py-3 text-right">${total.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</td>
            <td class="px-4 py-3 text-center">
                <button type="button" class="px-2 py-1 text-xs text-red-600 bg-red-100 rounded-md hover:bg-red-200" data-action="remover-item">Excluir</button>
            </td>`;
        tr.querySelector("[data-action='remover-item']").addEventListener("click", () => removerItem(item.id));
        itensContainer.appendChild(tr);
    }

    function renderizarItensNaTabela() {
        itensContainer.innerHTML = "";
        itens.forEach(adicionarItemNaTela);
        updateTableVisibility();
    }

    function removerItem(itemId) {
        itens = itens.filter(item => String(item.id) !== String(itemId));
        renderizarItensNaTabela();
    }

    function adicionarItem() {
        const nomeVal = itemInput.value.trim();
        const qtdVal = parseInt(itemQtdInput.value, 10);
        const valStr = itemValorInput.value;
        if (!nomeVal || isNaN(qtdVal) || qtdVal <= 0 || !valStr) {
            alert("Preencha Item, Quantidade e Valor para adicionar."); return;
        }
        const valVal = parseFloat(valStr.replace(/\./g, "").replace(",", "."));
        const novoItem = { id: `temp-${Date.now()}`, nome: nomeVal, quantidade: qtdVal, valor: valVal, tipo: 'manual' };
        itens.push(novoItem);
        renderizarItensNaTabela();
        limparCamposItem();
    }

    // --- Funções do Modal de Informações Adicionais ---
    function abrirModalInfo() {
        document.getElementById('info-condicao-pagamento').value = orcamentoData.condicao_pagamento || '';
        document.getElementById('info-prazo-entrega').value = orcamentoData.prazo_entrega || '';
        document.getElementById('info-garantia').value = orcamentoData.garantia || '';
        document.getElementById('info-observacoes').value = orcamentoData.observacoes || '';
        
        modalInfo.classList.remove('hidden');
        modalInfo.classList.add('flex');
        setTimeout(() => { modalInfoBox.classList.remove('-translate-y-10', 'opacity-0'); }, 50);
    }

    function fecharModalInfo() {
        modalInfoBox.classList.add('-translate-y-10', 'opacity-0');
        setTimeout(() => { modalInfo.classList.add('hidden'); modalInfo.classList.remove('flex'); }, 300);
    }

    function salvarInfoModal() {
        // Pega os valores do modal e salva nos campos ocultos
        const condicao = document.getElementById('info-condicao-pagamento').value;
        const prazo = document.getElementById('info-prazo-entrega').value;
        const garantia = document.getElementById('info-garantia').value;
        const obs = document.getElementById('info-observacoes').value;
        
        document.getElementById('hidden_condicao_pagamento').value = condicao;
        document.getElementById('hidden_prazo_entrega').value = prazo;
        document.getElementById('hidden_garantia').value = garantia;
        document.getElementById('hidden_observacoes').value = obs;
        
        fecharModalInfo();
    }
    
    // --- Preenchimento e Inicialização ---
    function preencherFormularioComDados() {
        const cliente = orcamentoData.cliente;
        document.getElementById('nome').value = cliente?.nome || orcamentoData.nome_cliente || '';
        document.getElementById('telefone').value = cliente?.telefone || orcamentoData.telefone_cliente || '';
        document.getElementById('cep').value = cliente?.cep || orcamentoData.cep_cliente || '';
        document.getElementById('logradouro').value = cliente?.logradouro || orcamentoData.logradouro_cliente || '';
        document.getElementById('numero_casa').value = cliente?.numero_casa || orcamentoData.numero_casa_cliente || '';
        document.getElementById('complemento').value = cliente?.complemento || orcamentoData.complemento_cliente || '';
        document.getElementById('bairro').value = cliente?.bairro || orcamentoData.bairro_cliente || '';
        document.getElementById('cidade_uf').value = cliente?.cidade_uf || orcamentoData.cidade_uf_cliente || '';
        
        document.getElementById('titulo_numero_orcamento').textContent = String(orcamentoData.numero).padStart(4, '0');
        document.getElementById('numero_orcamento').value = orcamentoData.numero;
        document.getElementById('descricaoServico').value = orcamentoData.descricao_servico || '';
        
        // Preenche também os campos ocultos de info adicional
        document.getElementById('hidden_condicao_pagamento').value = orcamentoData.condicao_pagamento || '';
        document.getElementById('hidden_prazo_entrega').value = orcamentoData.prazo_entrega || '';
        document.getElementById('hidden_garantia').value = orcamentoData.garantia || '';
        document.getElementById('hidden_observacoes').value = orcamentoData.observacoes || '';
        
        renderizarItensNaTabela();
    }

    function inicializar() {
        preencherFormularioComDados();
        adicionarItemBtn.addEventListener("click", adicionarItem);
        itemValorInput.addEventListener("input", formatarMoeda);
        document.getElementById("telefone").addEventListener("input", (e) => mascara(e, "(##) #####-####"));
        
        btnAbrirModalInfo.addEventListener('click', abrirModalInfo);
        btnFecharModalInfo.addEventListener('click', fecharModalInfo);
        btnSalvarInfo.addEventListener('click', salvarInfoModal);
    }

    inicializar();

    // Listener de submit final do formulário
    form.addEventListener("submit", function(e) {
        if (itens.length === 0) {
            alert("Adicione pelo menos um item ao orçamento para atualizar.");
            e.preventDefault();
            return;
        }
        document.getElementById("hiddenItens").value = JSON.stringify(itens);
    });
});
</script>

</body>
</html>